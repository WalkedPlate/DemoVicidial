{% extends "base.html" %}

{% block title %}Dashboard - CRM Vicidial{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Dashboard CRM - IntegraciÃ³n Vicidial</h2>
    </div>
</div>

<!-- Test de conexiÃ³n AMI -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Test de ConexiÃ³n AMI</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" onclick="testAMIConnection()">
                    Probar AMI
                </button>
                <button class="btn btn-info" onclick="getQueueStatus()">
                    Estado de Cola
                </button>
                <div id="ami-result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Crear Agente -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Crear Nuevo Agente</h5>
            </div>
            <div class="card-body">
                <form id="create-agent-form">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="agent_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="agent_email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Usuario Vicidial</label>
                        <input type="text" class="form-control" id="vicidial_user" placeholder="ej: agente001" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password Vicidial</label>
                        <input type="password" class="form-control" id="vicidial_user_pass" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">TelÃ©fono/ExtensiÃ³n</label>
                        <input type="text" class="form-control" id="vicidial_phone_login" placeholder="ej: 1001" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password TelÃ©fono</label>
                        <input type="password" class="form-control" id="vicidial_phone_pass" required>
                    </div>
                    <button type="submit" class="btn btn-success">Crear Agente</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lista de Agentes -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Agentes Existentes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Usuario</th>
                                <th>ExtensiÃ³n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agent in agents %}
                            <tr>
                                <td>{{ agent.name }}</td>
                                <td>{{ agent.vicidial_user }}</td>
                                <td>{{ agent.vicidial_phone_login }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if agent.is_logged_in_vicidial else 'secondary' }}">
                                        {{ agent.agent_status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('agent_view', agent_id=agent.id) }}" class="btn btn-success btn-sm">
                                            ðŸŽ§ Vista Agente
                                        </a>
                                        <button class="btn btn-primary btn-sm" onclick="amiAgentLogin({{ agent.id }})">
                                            AMI Login
                                        </button>
                                        <button class="btn btn-warning btn-sm" onclick="amiAgentLogout({{ agent.id }})">
                                            AMI Logout
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="amiPauseAgent({{ agent.id }})">
                                            Pausar
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="amiUnpauseAgent({{ agent.id }})">
                                            Listo
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs de actividad -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Log de Actividad</h5>
            </div>
            <div class="card-body">
                <div id="activity-log" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px;">
                    <small class="text-muted">AquÃ­ aparecerÃ¡n los logs de actividad...</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function logActivity(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logDiv = document.getElementById('activity-log');
    logDiv.innerHTML += `<div><small class="text-muted">[${timestamp}]</small> ${message}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
}

function testAMIConnection() {
    logActivity('Probando conexiÃ³n AMI...');

    fetch('/test_ami_connection')
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('ami-result');
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ“ AMI Funcionando!</strong><br>
                        ${data.message}<br>
                        <small>${data.response}</small>
                    </div>
                `;
                logActivity('âœ“ AMI conectado correctamente');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>âœ— Error AMI:</strong><br>
                        ${data.message}
                    </div>
                `;
                logActivity('âœ— Error AMI: ' + data.message);
            }
        });
}

function getQueueStatus() {
    logActivity('Consultando estado de cola DEMOIN...');

    fetch('/ami_queue_status')
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('ami-result');
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>ðŸ“Š Estado Cola DEMOIN:</strong><br>
                        <pre>${data.queue_status}</pre>
                    </div>
                `;
                logActivity('âœ“ Estado de cola obtenido');
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>âœ— Error:</strong> ${data.message}
                    </div>
                `;
                logActivity('âœ— Error consultando cola: ' + data.message);
            }
        });
}

document.getElementById('create-agent-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = {
        name: document.getElementById('agent_name').value,
        email: document.getElementById('agent_email').value,
        vicidial_user: document.getElementById('vicidial_user').value,
        vicidial_user_pass: document.getElementById('vicidial_user_pass').value,
        vicidial_phone_login: document.getElementById('vicidial_phone_login').value,
        vicidial_phone_pass: document.getElementById('vicidial_phone_pass').value,
        vicidial_user_group: 'ADMIN'  // Usar ADMIN por defecto
    };

    logActivity('Creando agente: ' + formData.name);

    fetch('/create_agent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Agente creado exitosamente', 'success');
            logActivity('âœ“ Agente creado: ' + formData.name);
            document.getElementById('create-agent-form').reset();
            location.reload(); // Recargar para ver el nuevo agente
        } else {
            showAlert('Error: ' + data.message, 'danger');
            logActivity('âœ— Error creando agente: ' + data.message);
        }
    })
    .catch(error => {
        showAlert('Error de red: ' + error.message, 'danger');
        logActivity('âœ— Error de red: ' + error.message);
    });
});

function amiAgentLogin(userId) {
    logActivity('Intentando AMI login para agente ID: ' + userId);

    fetch('/ami_agent_login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('âœ“ AMI Login exitoso', 'success');
            logActivity('âœ“ AMI Login exitoso para agente ID: ' + userId);
            location.reload();
        } else {
            showAlert('âœ— Error AMI Login: ' + data.message, 'danger');
            logActivity('âœ— Error AMI Login: ' + data.message);
        }
    });
}

function amiAgentLogout(userId) {
    logActivity('Intentando AMI logout para agente ID: ' + userId);

    fetch('/ami_agent_logout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('âœ“ AMI Logout exitoso', 'success');
            logActivity('âœ“ AMI Logout exitoso para agente ID: ' + userId);
            location.reload();
        } else {
            showAlert('âœ— Error AMI Logout: ' + data.message, 'danger');
            logActivity('âœ— Error AMI Logout: ' + data.message);
        }
    });
}

function amiPauseAgent(userId) {
    const reason = prompt('Motivo de pausa:', 'Break') || 'Break';
    logActivity('Pausando agente ID: ' + userId + ' - Motivo: ' + reason);

    fetch('/ami_pause_agent', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId, reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('â¸ï¸ Agente pausado: ' + reason, 'warning');
            logActivity('âœ“ Agente pausado: ' + reason);
            location.reload();
        } else {
            showAlert('âœ— Error pausando: ' + data.message, 'danger');
            logActivity('âœ— Error pausando: ' + data.message);
        }
    });
}

function amiUnpauseAgent(userId) {
    logActivity('Despausando agente ID: ' + userId);

    fetch('/ami_unpause_agent', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('â–¶ï¸ Agente listo para llamadas', 'success');
            logActivity('âœ“ Agente despausado y listo');
            location.reload();
        } else {
            showAlert('âœ— Error despausando: ' + data.message, 'danger');
            logActivity('âœ— Error despausando: ' + data.message);
        }
    });
}

// Auto-refrescar cada 30 segundos
setInterval(() => {
    logActivity('Refrescando datos...');
    location.reload();
}, 30000);
</script>
{% endblock %}