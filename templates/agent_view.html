{% extends "base.html" %}

{% block title %}Agente {{ agent.vicidial_user }} - Panel de Llamadas{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header del Agente -->
    <div class="row mb-3">
        <div class="col-12">
            <div id="statusCard" class="card bg-success text-white">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4>üéß {{ agent.name }} ({{ agent.vicidial_user }})</h4>
                        <p class="mb-0">Extensi√≥n: {{ agent.vicidial_phone_login }}</p>
                    </div>
                    <div class="text-end">
                        <h5 id="statusText">üü¢ CONECTANDO...</h5>
                        <div id="timer">00:00:00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Panel Principal -->
        <div class="col-md-8">
            <div class="card" style="min-height: 400px;">
                <!-- Estado: Esperando -->
                <div id="waitingState" class="card-body text-center py-5">
                    <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;"></div>
                    <h3 class="text-success">üü¢ LISTO PARA LLAMADAS</h3>
                    <p>Esperando llamada entrante...</p>
                    <div class="row mt-4">
                        <div class="col-6">
                            <h5>üìä Hoy</h5>
                            <p>Llamadas: <span id="callsToday">0</span></p>
                            <p>Tiempo: <span id="talkTime">00:00</span></p>
                        </div>
                        <div class="col-6">
                            <h5>üìã Cola</h5>
                            <p>En espera: <span id="queueWaiting">-</span></p>
                            <p>Agentes: <span id="queueAgents">-</span></p>
                        </div>
                    </div>
                </div>

                <!-- Estado: Llamada Entrante -->
                <div id="incomingState" class="card-body py-4" style="display: none;">
                    <div class="alert alert-primary text-center">
                        <h2>üìû LLAMADA ENTRANTE</h2>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h2 id="incomingNumber" class="text-primary">+1234567890</h2>
                            <h4 id="customerName">Cliente</h4>
                            <p id="customerLocation">Ciudad, Estado</p>
                            <p><strong>Campa√±a:</strong> <span id="campaignName">DEMOIN</span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5>‚è∞ Esperando</h5>
                                    <div id="waitTimer" style="font-size: 1.5rem;">00:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-success btn-lg me-3" onclick="answerCall()">
                            ‚úÖ CONTESTAR
                        </button>
                        <button class="btn btn-danger btn-lg" onclick="rejectCall()">
                            ‚ùå RECHAZAR
                        </button>
                    </div>
                </div>

                <!-- Estado: En Llamada -->
                <div id="activeState" class="card-body py-4" style="display: none;">
                    <div class="alert alert-info text-center">
                        <h2>üì± EN LLAMADA</h2>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h3 id="activeCustomer">Cliente Activo</h3>
                            <p id="activeNumber">+1234567890</p>
                            <p>Lead ID: <span id="leadId">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5>‚è±Ô∏è Duraci√≥n</h5>
                                    <div id="callDuration" style="font-size: 1.5rem;">00:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-warning me-2" onclick="holdCall()">‚è∏Ô∏è RETENER</button>
                        <button class="btn btn-info me-2" onclick="transferCall()">üìû TRANSFERIR</button>
                        <button class="btn btn-secondary me-2" onclick="toggleRecording()">üéôÔ∏è GRABAR</button>
                        <button class="btn btn-info" onclick="openMonitor()">üìä MONITOR LLAMADAS</button>
                        <button class="btn btn-danger" onclick="hangupCall()">üì± COLGAR</button>
                    </div>
                </div>

                <!-- Estado: Pausado -->
                <div id="pausedState" class="card-body text-center py-5" style="display: none;">
                    <h2 class="text-warning">‚è∏Ô∏è EN PAUSA</h2>
                    <p>Motivo: <span id="pauseReason">Break</span></p>
                    <div id="pauseTimer" style="font-size: 1.5rem;">00:00</div>
                    <button class="btn btn-success btn-lg mt-3" onclick="unpauseAgent()">
                        ‚ñ∂Ô∏è VOLVER
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-md-4">
            <!-- Controles -->
            <div class="card mb-3">
    <div class="card-header bg-dark text-white">
        <h6>üéõÔ∏è Control de Estados Vicidial</h6>
    </div>
    <div class="card-body">
        <!-- Estado actual -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span><strong>Estado Actual:</strong></span>
                <span id="currentAgentStatus" class="badge bg-secondary">LOGOUT</span>
            </div>
        </div>

        <!-- Controles de estado -->
        <div class="row g-2">
            <div class="col-6">
                <button id="readyBtn" class="btn btn-success w-100" onclick="setAgentStatus('READY')" disabled>
                    üü¢ READY
                </button>
            </div>
            <div class="col-6">
                <button id="pauseBtn" class="btn btn-warning w-100" onclick="showPauseOptions()" disabled>
                    ‚è∏Ô∏è PAUSA
                </button>
            </div>
        </div>

        <div class="row g-2 mt-2">
            <div class="col-12">
                <button class="btn btn-info w-100" onclick="refreshAgentStatus()">
                    üîÑ ACTUALIZAR ESTADO
                </button>
            </div>
        </div>

        <div class="row g-2 mt-2">
            <div class="col-6">
                <button class="btn btn-secondary w-100" onclick="openStatusMonitor()">
                    üìä MONITOR
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-danger w-100" onclick="logoutAgent()">
                    üö™ SALIR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de opciones de pausa -->
<div class="modal fade" id="pauseOptionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚è∏Ô∏è Motivo de Pausa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning" onclick="confirmPauseWithReason('BREAK')">
                        ‚òï Break
                    </button>
                    <button class="btn btn-outline-warning" onclick="confirmPauseWithReason('LUNCH')">
                        üçΩÔ∏è Almuerzo
                    </button>
                    <button class="btn btn-outline-warning" onclick="confirmPauseWithReason('TRAINING')">
                        üìö Capacitaci√≥n
                    </button>
                    <button class="btn btn-outline-warning" onclick="confirmPauseWithReason('MEETING')">
                        ü§ù Reuni√≥n
                    </button>
                    <button class="btn btn-outline-warning" onclick="confirmPauseWithReason('TECHNICAL')">
                        üîß Problema T√©cnico
                    </button>
                    <button class="btn btn-outline-warning" onclick="confirmPauseWithReason('OTHER')">
                        ‚ùì Otro
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Estado Sistema -->
            <div class="card">
                <div class="card-header">
                    <h6>üîß Sistema</h6>
                </div>
                <div class="card-body">
                    <small>
                        <div>WebSocket: <span id="wsStatus" class="badge bg-secondary">-</span></div>
                        <div>AMI: <span id="amiStatus" class="badge bg-secondary">-</span></div>
                        <div>SIP: <span id="sipStatus" class="badge bg-secondary">-</span></div>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Pausa -->
<div class="modal fade" id="pauseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>‚è∏Ô∏è Solicitar Pausa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select class="form-select" id="pauseReasonSelect">
                    <option value="BREAK">Break</option>
                    <option value="LUNCH">Almuerzo</option>
                    <option value="MEETING">Reuni√≥n</option>
                    <option value="TECHNICAL">T√©cnico</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-warning" onclick="confirmPause()">Pausar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// Variables
const agentId = {{ agent.id }};
const agentUser = '{{ agent.vicidial_user }}';
const agentExtension = '{{ agent.vicidial_phone_login }}';

let socket = null;
let currentCall = null;
let agentStatus = 'LOGOUT';
let callTimer = null;
let pauseTimer = null;
let waitTimer = null;

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    autoLoginAgent();
    startPolling();
    updateAgentControls();
});

function connectWebSocket() {
    socket = io();

    socket.on('connect', function() {
        updateStatus('wsStatus', 'Conectado', 'success');
        socket.emit('join_agent', {extension: agentExtension});
    });

    socket.on('incoming_call', function(callData) {
    // Filtrar llamadas de setup del agente
    if (callData.caller_id === '5551234567' || callData.caller_id === agentExtension) {
        console.log('üîß Conexi√≥n de setup ignorada:', callData.caller_id);
        return;
    }

    currentCall = callData;
    showIncomingCall(callData);
    showAlert('üìû Llamada entrante: ' + callData.caller_id, 'info');
});

    socket.on('call_connected', function(callData) {
        showActiveCall();
        startCallTimer();
    });

    socket.on('call_ended', function(callData) {
        handleCallEnd();
    });
    socket.on('agent_auto_connected', function(data) {
    console.log('üéß Agente auto-conectado:', data);
    showAlert('üéß MicroSIP conectado a MeetMe ' + data.meetme_room, 'success');
    updateStatus('sipStatus', 'MeetMe ' + data.meetme_room, 'success');
});
}

function autoLoginAgent() {
    updateStatus('amiStatus', 'Conectando', 'warning');

    fetch('/vicidial_agent_login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({agent_id: agentId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agentStatus = data.final_status || 'READY';
            updateAgentControls();
            updateAgentStatus();
            updateStatus('amiStatus', 'Conectado', 'success');
            updateStatus('sipStatus', 'MeetMe ' + data.meetme_room, 'success');

            if (data.ready_for_calls) {
                showAlert('‚úÖ Agente LISTO para recibir llamadas', 'success');
            } else {
                showAlert(`‚ö†Ô∏è Login exitoso pero estado: ${data.final_status}`, 'warning');
            }
        } else {
            showAlert('‚ùå Error: ' + data.message, 'danger');
            updateStatus('amiStatus', 'Error', 'danger');
        }
    });
}

function startPolling() {
    setInterval(function() {
        fetch(`/agent_calls/${agentId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateFromPoll(data);
                }
            })
            .catch(error => console.log('Poll error:', error));
    }, 3000);
}

function updateFromPoll(data) {
    if (data.agent_status !== agentStatus) {
        agentStatus = data.agent_status;
        updateAgentStatus();
    }

    if (data.calls.length > 0 && !currentCall) {
        const call = data.calls[0];
        if (call.status === 'RING' || call.status === 'QUEUE') {
            currentCall = call;
            showIncomingCall(call);
        } else if (call.status === 'LIVE') {
            currentCall = call;
            showActiveCall();
            startCallTimer();
        }
    } else if (data.calls.length === 0 && currentCall) {
        handleCallEnd();
    }
}

// Estados de la vista
function showWaitingState() {
    hideAllStates();
    document.getElementById('waitingState').style.display = 'block';
    updateStatusCard('success', 'üü¢ LISTO');
}

function showIncomingCall(callData) {
    hideAllStates();
    document.getElementById('incomingState').style.display = 'block';
    updateStatusCard('primary', 'üìû LLAMADA ENTRANTE');

    document.getElementById('incomingNumber').textContent = callData.phone_number || 'Sin n√∫mero';
    document.getElementById('customerName').textContent =
        `${callData.first_name || ''} ${callData.last_name || ''}`.trim() || 'Sin nombre';
    document.getElementById('customerLocation').textContent =
        `${callData.city || ''}, ${callData.state || ''}`;

    startWaitTimer();

    // EN SISTEMA REAL: AUTO-CONECTAR DESPU√âS DE 2 SEGUNDOS
    setTimeout(() => {
        showAlert('üéß Llamada conectada autom√°ticamente via MeetMe', 'success');
        agentStatus = 'INCALL';
        showActiveCall();
        startCallTimer();
        stopWaitTimer();
    }, 2000);
}

function showActiveCall() {
    hideAllStates();
    document.getElementById('activeState').style.display = 'block';
    updateStatusCard('info', 'üì± EN LLAMADA');

    if (currentCall) {
        document.getElementById('activeCustomer').textContent =
            `${currentCall.first_name || ''} ${currentCall.last_name || ''}`.trim() || 'Cliente';
        document.getElementById('activeNumber').textContent = currentCall.phone_number || '';
        document.getElementById('leadId').textContent = currentCall.lead_id || '-';
    }
}

function showPausedState() {
    hideAllStates();
    document.getElementById('pausedState').style.display = 'block';
    updateStatusCard('warning', '‚è∏Ô∏è EN PAUSA');
    startPauseTimer();
}

function hideAllStates() {
    document.getElementById('waitingState').style.display = 'none';
    document.getElementById('incomingState').style.display = 'none';
    document.getElementById('activeState').style.display = 'none';
    document.getElementById('pausedState').style.display = 'none';
}

function updateAgentStatus() {
    const pauseBtn = document.getElementById('pauseBtn');

    switch(agentStatus) {
        case 'READY':
            showWaitingState();
            pauseBtn.innerHTML = '‚è∏Ô∏è PAUSA';
            pauseBtn.disabled = false;
            break;
        case 'PAUSED':
            showPausedState();
            pauseBtn.innerHTML = '‚ñ∂Ô∏è VOLVER';
            pauseBtn.disabled = false;
            break;
        case 'INCALL':
            updateStatusCard('info', 'üì± EN LLAMADA');
            pauseBtn.disabled = true;
            break;
    }
}

function updateStatusCard(type, text) {
    const card = document.getElementById('statusCard');
    const statusText = document.getElementById('statusText');

    card.className = `card bg-${type} text-white`;
    statusText.textContent = text;
}

// Acciones del agente
function answerCall() {
    if (currentCall) {
        showAlert('üìû MicroSIP contestando autom√°ticamente...', 'info');
        setTimeout(() => {
            agentStatus = 'INCALL';
            showActiveCall();
            startCallTimer();
            showAlert('‚úÖ Llamada conectada', 'success');
        }, 1000);
    }
}

function rejectCall() {
    if (currentCall) {
        showAlert('‚ùå Llamada rechazada', 'warning');
        handleCallEnd();
    }
}

function togglePause() {
    if (agentStatus === 'PAUSED') {
        unpauseAgent();
    } else {
        const modal = new bootstrap.Modal(document.getElementById('pauseModal'));
        modal.show();
    }
}

function confirmPause() {
    const reason = document.getElementById('pauseReasonSelect').value;

    fetch('/vicidial_agent_pause', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({agent_id: agentId, reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agentStatus = 'PAUSED';
            document.getElementById('pauseReason').textContent = reason;
            updateAgentStatus();
            bootstrap.Modal.getInstance(document.getElementById('pauseModal')).hide();
            showAlert('‚è∏Ô∏è Pausado: ' + reason, 'warning');
        }
    });
}

function unpauseAgent() {
    fetch('/vicidial_agent_unpause', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({agent_id: agentId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agentStatus = 'READY';
            updateAgentStatus();
            stopPauseTimer();
            showAlert('‚ñ∂Ô∏è Agente disponible para llamadas', 'success');
        }
    });
}

function hangupCall() {
    if (currentCall) {
        showAlert('üì± Llamada terminada', 'info');
        handleCallEnd();
    }
}

function openMonitor() {
    window.open('/monitor_real_calls', '_blank');
}

function handleCallEnd() {
    stopCallTimer();
    stopWaitTimer();
    currentCall = null;
    agentStatus = 'READY';
    updateAgentStatus();
}

function logoutAgent() {
    if (confirm('¬øCerrar sesi√≥n?')) {
        fetch('/vicidial_agent_logout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({agent_id: agentId})
        })
        .then(() => {
            showAlert('üëã Sesi√≥n cerrada', 'info');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);
        });
    }
}

function simulateCall() {
    fetch(`/simulate_call/${agentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('üìû Llamada simulada enviada', 'info');
            }
        });
}

// Funci√≥n para cambiar estado del agente
function setAgentStatus(newStatus) {
    if (newStatus === agentStatus) {
        showAlert(`Ya est√°s en estado ${newStatus}`, 'info');
        return;
    }

    showAlert(`Cambiando a estado ${newStatus}...`, 'info');

    let endpoint = '';
    let payload = {agent_id: agentId};

    switch(newStatus) {
        case 'READY':
            endpoint = '/vicidial_agent_unpause';
            break;
        case 'PAUSED':
            showPauseOptions();
            return;
        default:
            showAlert('Estado no v√°lido', 'danger');
            return;
    }

    fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agentStatus = newStatus;
            updateAgentControls();
            showAlert(`‚úÖ Estado cambiado a ${newStatus}`, 'success');
        } else {
            showAlert(`‚ùå Error: ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'danger');
    });
}

function showPauseOptions() {
    const modal = new bootstrap.Modal(document.getElementById('pauseOptionsModal'));
    modal.show();
}

function confirmPauseWithReason(reason) {
    fetch('/vicidial_agent_pause', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({agent_id: agentId, reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agentStatus = 'PAUSED';
            updateAgentControls();
            bootstrap.Modal.getInstance(document.getElementById('pauseOptionsModal')).hide();
            showAlert(`‚è∏Ô∏è Pausado: ${reason}`, 'warning');
        } else {
            showAlert(`‚ùå Error: ${data.message}`, 'danger');
        }
    });
}

function updateAgentControls() {
    const currentStatusBadge = document.getElementById('currentAgentStatus');
    const readyBtn = document.getElementById('readyBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    // Actualizar badge de estado
    currentStatusBadge.textContent = agentStatus;
    currentStatusBadge.className = 'badge';

    // Resetear botones
    readyBtn.disabled = false;
    pauseBtn.disabled = false;

    switch(agentStatus) {
        case 'READY':
            currentStatusBadge.classList.add('bg-success');
            readyBtn.disabled = true; // Ya est√° en READY
            updateStatusCard('success', 'üü¢ LISTO');
            break;
        case 'PAUSED':
            currentStatusBadge.classList.add('bg-warning');
            pauseBtn.disabled = true; // Ya est√° pausado
            updateStatusCard('warning', '‚è∏Ô∏è EN PAUSA');
            break;
        case 'INCALL':
            currentStatusBadge.classList.add('bg-info');
            readyBtn.disabled = true;
            pauseBtn.disabled = true; // No puede pausar en llamada
            updateStatusCard('info', 'üì± EN LLAMADA');
            break;
        case 'LOGOUT':
            currentStatusBadge.classList.add('bg-danger');
            readyBtn.disabled = true;
            pauseBtn.disabled = true;
            updateStatusCard('danger', 'üî¥ DESCONECTADO');
            break;
        default:
            currentStatusBadge.classList.add('bg-secondary');
    }
}

function refreshAgentStatus() {
    showAlert('üîÑ Consultando estado...', 'info');

    fetch(`/monitor_agent_status/${agentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                agentStatus = data.current_status.status || 'LOGOUT';
                updateAgentControls();
                updateAgentStatus();
                showAlert(`‚úÖ Estado actualizado: ${agentStatus}`, 'success');

                // Mostrar cambios inesperados
                if (data.analysis.unexpected_changes > 0) {
                    showAlert(`‚ö†Ô∏è Se detectaron ${data.analysis.unexpected_changes} cambios de estado recientes`, 'warning');
                }
            } else {
                showAlert(`‚ùå Error: ${data.error}`, 'danger');
            }
        });
}

function openStatusMonitor() {
    window.open(`/monitor_agent_status/${agentId}`, '_blank');
}

function testInboundCall() {
    // Primero asegurar que est√© READY
    fetch(`/force_agent_ready/${agentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('‚úÖ Agente listo para recibir llamadas', 'success');
                showAlert('üìû Ahora llama al 01 4125924 desde tu celular', 'info');
            }
        });
}

// Timers
function startCallTimer() {
    const startTime = Date.now();
    callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('callDuration').textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopCallTimer() {
    if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
    }
}

function startWaitTimer() {
    const startTime = Date.now();
    waitTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('waitTimer').textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopWaitTimer() {
    if (waitTimer) {
        clearInterval(waitTimer);
        waitTimer = null;
    }
}

function startPauseTimer() {
    const startTime = Date.now();
    pauseTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('pauseTimer').textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopPauseTimer() {
    if (pauseTimer) {
        clearInterval(pauseTimer);
        pauseTimer = null;
    }
}

// Utilidades
function updateStatus(elementId, text, type) {
    const element = document.getElementById(elementId);
    element.textContent = text;
    element.className = `badge bg-${type}`;
}

function refreshStatus() {
    showAlert('üîÑ Actualizando estado...', 'info');
    location.reload();
}

function showAlert(message, type) {
    console.log(message);
    alert(message);
}

// Timer principal
setInterval(() => {
    document.getElementById('timer').textContent = new Date().toLocaleTimeString();
}, 1000);

// Limpiar al salir
window.addEventListener('beforeunload', function() {
    if (socket) socket.disconnect();
    stopCallTimer();
    stopWaitTimer();
    stopPauseTimer();
});
</script>
{% endblock %}