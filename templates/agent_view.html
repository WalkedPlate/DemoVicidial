{% extends "base.html" %}

{% block title %}Agente {{ agent.vicidial_user }} - Vista de Llamadas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Header del Agente -->
        <div class="col-12">
            <div class="card bg-dark text-white mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4>üéß Agente: {{ agent.name }} ({{ agent.vicidial_user }})</h4>
                        <p class="mb-0">Extensi√≥n: {{ agent.vicidial_phone_login }}</p>
                    </div>
                    <div class="text-end">
                        <div class="btn-group">
                            <button id="pauseBtn" class="btn btn-warning" onclick="togglePause()">
                                ‚è∏Ô∏è PAUSAR
                            </button>
                            <button class="btn btn-danger" onclick="logout()">
                                üö™ SALIR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Panel Principal de Llamada -->
        <div class="col-md-8">
            <div id="callPanel" class="card" style="min-height: 400px;">
                <div class="card-header bg-success text-white">
                    <h5 id="statusTitle">üü¢ LISTO PARA RECIBIR LLAMADAS</h5>
                </div>
                <div class="card-body text-center">
                    <!-- Estado Esperando -->
                    <div id="waitingState" class="py-5">
                        <div class="spinner-border text-success mb-3" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Esperando...</span>
                        </div>
                        <h3 class="text-muted">Esperando llamada entrante...</h3>
                        <p>Estado: <span id="agentStatus" class="badge bg-success">READY</span></p>
                    </div>

                    <!-- Llamada Entrante -->
                    <div id="incomingCall" class="py-4" style="display: none;">
                        <div class="alert alert-primary">
                            <h2>üìû LLAMADA ENTRANTE</h2>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h1 id="callerNumber" class="display-4 text-primary">+1234567890</h1>
                                <p class="text-muted">N√∫mero de tel√©fono</p>
                            </div>
                            <div class="col-md-6">
                                <h3 id="callerName">Juan P√©rez</h3>
                                <p id="callerLocation" class="text-muted">Lima, Per√∫</p>
                                <p><strong>Campa√±a:</strong> <span id="campaignName">DEMOIN</span></p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="btn btn-success btn-lg me-3" onclick="answerCall()">
                                ‚úÖ CONTESTAR
                            </button>
                            <button class="btn btn-danger btn-lg" onclick="rejectCall()">
                                ‚ùå RECHAZAR
                            </button>
                        </div>
                    </div>

                    <!-- En Llamada -->
                    <div id="activeCall" class="py-4" style="display: none;">
                        <div class="alert alert-info">
                            <h2>üì± EN LLAMADA</h2>
                        </div>
                        <h3 id="activeCallerName">Cliente Activo</h3>
                        <p>Duraci√≥n: <span id="callDuration">00:00</span></p>
                        <div class="mt-4">
                            <button class="btn btn-warning me-2" onclick="holdCall()">
                                ‚è∏Ô∏è RETENER
                            </button>
                            <button class="btn btn-info me-2" onclick="transferCall()">
                                üìû TRANSFERIR
                            </button>
                            <button class="btn btn-danger" onclick="hangupCall()">
                                üì± COLGAR
                            </button>
                        </div>
                    </div>

                    <!-- Pausado -->
                    <div id="pausedState" class="py-5" style="display: none;">
                        <h2 class="text-warning">‚è∏Ô∏è AGENTE EN PAUSA</h2>
                        <p>Motivo: <span id="pauseReason">Break</span></p>
                        <button class="btn btn-success btn-lg" onclick="unpause()">
                            ‚ñ∂Ô∏è VOLVER A DISPONIBLE
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Informaci√≥n -->
        <div class="col-md-4">
            <!-- Estad√≠sticas del D√≠a -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6>üìä Estad√≠sticas de Hoy</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 id="callsToday">0</h4>
                            <small>Llamadas</small>
                        </div>
                        <div class="col-6">
                            <h4 id="talkTime">00:00</h4>
                            <small>Tiempo</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Llamadas -->
            <div class="card">
                <div class="card-header">
                    <h6>üìã √öltimas Llamadas</h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="callHistory">
                        <p class="text-muted">No hay llamadas recientes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Variables JavaScript -->
<script>
const agentId = {{ agent.id }};
const agentUser = '{{ agent.vicidial_user }}';
let currentCall = null;
let callStartTime = null;
let isPaused = false;
let pollInterval = null;

// Estados de la vista
function showWaiting() {
    document.getElementById('waitingState').style.display = 'block';
    document.getElementById('incomingCall').style.display = 'none';
    document.getElementById('activeCall').style.display = 'none';
    document.getElementById('pausedState').style.display = 'none';
    document.getElementById('statusTitle').innerHTML = 'üü¢ LISTO PARA RECIBIR LLAMADAS';
    document.getElementById('callPanel').className = 'card';
}

function showIncomingCall(call) {
    document.getElementById('waitingState').style.display = 'none';
    document.getElementById('incomingCall').style.display = 'block';
    document.getElementById('activeCall').style.display = 'none';
    document.getElementById('pausedState').style.display = 'none';
    document.getElementById('statusTitle').innerHTML = 'üìû LLAMADA ENTRANTE';
    document.getElementById('callPanel').className = 'card border-primary';
    
    // Llenar datos de la llamada
    document.getElementById('callerNumber').textContent = call.phone_number;
    document.getElementById('callerName').textContent = `${call.first_name || ''} ${call.last_name || ''}`.trim() || 'Cliente';
    document.getElementById('callerLocation').textContent = `${call.city || ''}, ${call.state || ''}`.trim() || 'Ubicaci√≥n no disponible';
    document.getElementById('campaignName').textContent = call.campaign_id;
}

function showActiveCall(call) {
    document.getElementById('waitingState').style.display = 'none';
    document.getElementById('incomingCall').style.display = 'none';
    document.getElementById('activeCall').style.display = 'block';
    document.getElementById('pausedState').style.display = 'none';
    document.getElementById('statusTitle').innerHTML = 'üì± EN LLAMADA ACTIVA';
    document.getElementById('callPanel').className = 'card border-info';
    
    document.getElementById('activeCallerName').textContent = `${call.first_name || ''} ${call.last_name || ''}`.trim() || 'Cliente';
}

function showPaused() {
    document.getElementById('waitingState').style.display = 'none';
    document.getElementById('incomingCall').style.display = 'none';
    document.getElementById('activeCall').style.display = 'none';
    document.getElementById('pausedState').style.display = 'block';
    document.getElementById('statusTitle').innerHTML = '‚è∏Ô∏è AGENTE EN PAUSA';
    document.getElementById('callPanel').className = 'card border-warning';
}

// Polling para obtener llamadas
function pollForCalls() {
    fetch(`/agent_calls/${agentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateAgentView(data.calls, data.agent_status);
            }
        })
        .catch(error => console.error('Error polling:', error));
}

// Actualizar vista seg√∫n estado
function updateAgentView(calls, agentStatus) {
    document.getElementById('agentStatus').textContent = agentStatus;
    
    if (agentStatus === 'PAUSED') {
        showPaused();
        document.getElementById('pauseBtn').innerHTML = '‚ñ∂Ô∏è DISPONIBLE';
        isPaused = true;
    } else if (calls.length > 0) {
        const call = calls[0];
        if (call.status === 'RING' || call.status === 'QUEUE') {
            showIncomingCall(call);
            currentCall = call;
        } else if (call.status === 'LIVE' || call.status === 'INCALL') {
            showActiveCall(call);
            currentCall = call;
        }
    } else {
        showWaiting();
        currentCall = null;
        document.getElementById('pauseBtn').innerHTML = '‚è∏Ô∏è PAUSAR';
        isPaused = false;
    }
}

// Acciones del agente
function togglePause() {
    if (isPaused) {
        unpause();
    } else {
        const reason = prompt('Motivo de pausa:', 'Break') || 'Break';
        pauseAgent(reason);
    }
}

function pauseAgent(reason) {
    fetch('/agent_pause', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({agent_id: agentId, reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('pauseReason').textContent = reason;
        }
    });
}

function unpause() {
    fetch('/agent_unpause', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({agent_id: agentId})
    })
    .then(response => response.json())
    .then(data => {
        // La vista se actualizar√° en el pr√≥ximo poll
    });
}

function answerCall() {
    if (currentCall) {
        // En un sistema real, esto notificar√≠a a Asterisk
        alert('Llamada contestada - En desarrollo');
    }
}

function rejectCall() {
    if (currentCall) {
        alert('Llamada rechazada - En desarrollo');
    }
}

function hangupCall() {
    if (currentCall) {
        alert('Llamada colgada - En desarrollo');
    }
}

function logout() {
    if (confirm('¬øSeguro que desea salir?')) {
        clearInterval(pollInterval);
        window.location.href = '/dashboard';
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    showWaiting();
    
    // Iniciar polling cada 2 segundos
    pollInterval = setInterval(pollForCalls, 2000);
    
    // Primera consulta inmediata
    pollForCalls();
});

// Limpiar al salir
window.addEventListener('beforeunload', function() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
});
</script>
{% endblock %}